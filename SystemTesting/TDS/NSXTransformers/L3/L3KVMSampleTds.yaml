{% include 'TDS/NSXTransformers/L3/KVMTestbedSpec.yaml' %}
{% include 'TDS/NSXTransformers/L3/AutoGeneratedWorkloads.yaml' %}
{% include 'TDS/NSXTransformers/Common/Topo_Clusters.yaml' %}

L3KVMBasic:
    Category: L3
    Component: Basic Routing
    Summary: This test case verifies that connectivity works between 2 KVM
             VMs on 2 logical switches connected through a logical router
    Tags: nsx,avalanche
    Version: 2
    TestName: L3KVMBasic
    TestbedSpec: *L3KvmTestbedSpec

    WORKLOADS:
        <<: *Topo_3MP_3CCP
        Sequence:
             - - ClusterSetup
             - - ClusterVerification
             - - SetManagerOnKVM-1
               - SetManagerOnKVM-2
             - - DiscoverHostNode1FromKVM1
               - DiscoverHostNode2FromKVM2
             - - CreateTZ-1
             - - CreateUPROF-1_MTU-1600
             - - CreateTN-1_HOSTNODE-1_TZ-1_ETH-1
               - CreateTN-2_HOSTNODE-2_TZ-1_ETH-1
             - - DiscoverVteps
             - - ConfigureIPForVteps
             - - VerifyVTEPConnectivity
             - - CreateLS-1
               - CreateLS-2
             - - AddVM1Vif1ToKVM1Bridge1
             - - AddVM2Vif1ToKVM2Bridge1
             - - AddVM3Vif1ToKVM1Bridge1
             - - AddVM4Vif1ToKVM2Bridge1
             - - CreateLP1OnLS1ForVM1Vif1
               - CreateLP2OnLS2ForVM2Vif1
             - - CreateLP3OnLS1ForVM3Vif1
               - CreateLP4OnLS2ForVM4Vif1
             - - CreateLSP-101_LS-1_ATYPE-logicalrouter
               - CreateLSP-102_LS-2_ATYPE-logicalrouter
             - - CreateLR-1
             - - CreateLRP-1_IP-192.168.1.1_LSP-101
             - - CreateLRP-2_IP-192.168.2.1_LSP-102
             - - ConfigureVM1Vif1IP-192.168.1.10
               - ConfigureVM2Vif1IP-192.168.2.10
               - ConfigureVM3Vif1IP-192.168.1.11
               - ConfigureVM4Vif1IP-192.168.2.11
             - - AddRouteOnVM1Vif1_VM2Vif1viaLRP1
             - - AddRouteOnVM2Vif1_VM1Vif1viaLRP2
             - - AddRouteOnVM3Vif1_VM2Vif1viaLRP1
             - - AddRouteOnVM4Vif1_VM1Vif1viaLRP2
             - - ListDRs
             - - PingFromVM1Vif1ToVM3Vif1
               - PingFromVM2Vif1ToVM4Vif1
             - - PingFromVM1Vif1ToVM2Vif1
               - PingFromVM3Vif1ToVM4Vif1
        ExitSequence:
             - [DeleteVif-1_VM-1, DeleteVif-1_VM-2,
                DeleteVif-1_VM-3, DeleteVif-1_VM-4]
             # FIXME: BUG 1380630, Parallel Deletion of lrport fails
             - - DeleteLRP-1
             - - DeleteLRP-2
             - [DeleteLR-1]
             - [DeleteLSP-1, DeleteLSP-2, DeleteLSP-3, DeleteLSP-4]
             - [DeleteLSP-101, DeleteLSP-102]
             - [DeleteLS-1, DeleteLS-2]
             - [DeleteTN-1, DeleteTN-2]
             - [DeleteUPROF-1]
             - [DeleteTZ-1]
             - [DeleteHostNode-1, DeleteHostNode-2]
             # WORKAROUND (dbadiani) - PR1434458
             # Remove CCP cleanup to fix CAT failure
             # - - ClusterCleanup

        ListDRs:
            Type: Host
            TestHost: kvm.[1-2]
            execution_type: 'cli'
            get_logical_routers[?]contain_once:
                table:
                    - lr_uuid: nsxmanager.[1].logicalrouter.[1]->logical_router_id

        DiscoverVteps:
            Type: Host
            TestHost: kvm.[1-2]
            vtep:
                '[1]':
                    discover: 'true'
                    # Name of the VTEP is of form nsx-vtepX.Y where X is the
                    # index of the VTEP interface and Y is the index of the
                    # transport bridge on the host.
                    name: nsx-vtep0.0

        ConfigureIPForVteps:
            Type: NetAdapter
            TestAdapter: kvm.[1-2].vtep.[1]
            IPv4: auto

        VerifyVTEPConnectivity:
            Type          : Traffic
            ToolName      : ping
            TestAdapter   : kvm.[2].vtep.[1]
            SupportAdapter: kvm.[1].vtep.[1]
            TestDuration  : 5
