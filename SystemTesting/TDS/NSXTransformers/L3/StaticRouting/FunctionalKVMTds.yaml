{% include 'TDS/NSXTransformers/L3/StaticRouting/TestbedSpec.yaml' %}
{% include 'TDS/NSXTransformers/Common/Topo_Clusters.yaml' %}
{% include 'TDS/NSXTransformers/L3/StaticRouting/TopoSR_2Hosts_NoEdge.yaml' %}
{% include 'TDS/NSXTransformers/L3/StaticRouting/TopoSR_2Hosts_1Edge_PlrTlr.yaml' %}
{% include 'TDS/NSXTransformers/L3/StaticRouting/AutoGeneratedWorkloads.yaml' %}

tds_template: &tds_template
    AutomationLevel: Automated
    Category: L3
    Component: StaticRouting
    Developer: miriyalak
    Duration: 3600
    ExpectedResult: PASS
    FullyAutomatable: Y
    PartnerFacing: N
    PMT: null
    Procedure: null
    Product: NSXTransformers
    QCPath: KVM
    Status: Execution Ready
    TCMSId: null
    TestcaseLevel: Functional
    TestcaseType: Functional
    Version: 2

p0_template: &p0_template
    <<: *tds_template
    Priority: P0

p1_template: &p1_template
    <<: *tds_template
    Priority: P1

BasicRouteMetrics:
    <<: *p0_template
    Summary: |
        Basic Static Route Metrics
        - Verify that connected routes on the Plr have metric = 0
        - Verify that static routes on the Plr have metric = 1
        (single-tier will not have internal routes. Do not check them)
        Since metric field is not avaliable just checking with invalid route
        with same prefix as below,
        - Add a static route to the same prefix as connected route
        - Check that connectivity still works with conflicting route
    Tags: cat,kvm,nsxtransformers,l3,staticroutes,routemetric
    TestbedSpec: *TestBed_2KVM_ESXEdge
    TestName: BasicRouteMetrics
    WORKLOADS:
        <<: *Topo_3MP_3CCP
        <<: *TopoSR_2Hosts_NoEdge
        Sequence:
            - - ClusterSetup
            - - ClusterVerification
            - - LogicalSetup
            - - TNSetup--KVM
            - - VMSetup--KVM
            - - L3Setup--KVM
            - - SRSetup--KVM
            - - L3SetupVerification--KVM
            - - L2Traffic--KVM
              - L3Traffic--KVM
              - SRTraffic--KVM
            - - L3TrafficVerification--KVM
            - - AddConflictingRouteOnLR-1_VM1Vif2viaVM1Vif1onLRP1_VM4Vif2viaVM4Vif1onLRP2_VM1Vif1viaVM3Vif1
            - - L2Traffic--KVM
              - L3Traffic--KVM
              - SRTraffic--KVM
        ExitSequence:
            - - SRCleanup--KVM
            - - L3Cleanup--KVM
            - - VMCleanup--KVM
            - - TNCleanup--KVM
            - - LogicalCleanup
            - - ClusterCleanup

BasicStaticRoutes:
    <<: *p0_template
    Summary: |
        Basic Static Routes
        - Verify that static routes can be added to Plr
        - Verify that traffic follows the static routes
    Tags: cat,kvm,nsxtransformers,l3,staticroutes
    TestbedSpec: *TestBed_2KVM_ESXEdge
    TestName: BasicStaticRoutes
    WORKLOADS:
        <<: *Topo_3MP_3CCP
        <<: *TopoSR_2Hosts_NoEdge
        Sequence:
            - - ClusterSetup
            - - ClusterVerification
            - - LogicalSetup
            - - TNSetup--KVM
            - - VMSetup--KVM
            - - L3Setup--KVM
            - - SRSetup--KVM
            - - L3SetupVerification--KVM
            - - L2Traffic--KVM
              - L3Traffic--KVM
              - SRTraffic--KVM
            - - L3TrafficVerification--KVM
        ExitSequence:
            - - SRCleanup--KVM
            - - L3Cleanup--KVM
            - - VMCleanup--KVM
            - - TNCleanup--KVM
            - - LogicalCleanup
            - - ClusterCleanup

BasicLogicalOperations:
    <<: *p1_template
    Summary: |
        Basic Logical Operations,
        - Verify that east-west & north-south traffic resume after following operations
        - Remove/add static routes on Plr
        - Remove/add static routes on Tlr
    Tags: cat,kvm,nsxtransformers,l3,staticroutes,operations
    TestbedSpec: *TestBed_2KVM_ESXEdge
    TestName: BasicLogicalOperations
    WORKLOADS:
        <<: *Topo_3MP_3CCP
        <<: *TopoSR_2Hosts_1Edge_PlrTlr
        Sequence:
            - - ClusterSetup
            - - ClusterVerification
            - - PlrTlrSetup--KVM
            - - Traffic--KVM
            - - DisableRouteAdvertisementOnTlrs
            - - DeleteStaticRoutesOnTlrs
            - - AddStaticRoutesOnTlrs--KVM
            - - EnableRouteAdvertisementOnTlrs
            - - Traffic--KVM
        ExitSequence:
            - - PlrTlrCleanup--KVM
            - - ClusterCleanup
