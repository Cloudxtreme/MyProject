{% include 'TDS/NSXTransformers/L3/StaticRouting/TestbedSpec.yaml' %}
{% include 'TDS/NSXTransformers/L3/StaticRouting/AutoGeneratedWorkloads.yaml' %}
{% include 'TDS/NSXTransformers/L3/StaticRouting/TopoSR_2Hosts_1Edge_Plr.yaml' %}
{% include 'TDS/NSXTransformers/Common/Topo_Clusters.yaml' %}

tds_template: &tds_template
    AutomationLevel: Automated
    Category: L3
    Component: StaticRouting
    Developer: miriyalak
    Duration: 3600
    ExpectedResult: PASS
    FullyAutomatable: Y
    PartnerFacing: N
    PMT: null
    Procedure: null
    Product: NSXTransformers
    QCPath: ESX
    Status: Execution Ready
    Tags: cat,esx,nsxtransformers,l3,staticroutes,operations
    TCMSId: null
    TestcaseLevel: Functional
    TestcaseType: Functional
    Version: 2

p2_template: &p2_template
    <<: *tds_template
    Priority: P2

PLRDownUpUplinkLIF:
    <<: *p2_template
    Summary: Verify that traffic resumes after Down/Up Lifs on PLR
    TestbedSpec: *TestBed_2KVM_ESXEdge
    TestName: PLRDownUpUplinkLIF
    WORKLOADS:
        <<: *TopoSR_2Hosts_1Edge_Plr
        <<: *Topo_3MP_3CCP
        Sequence:
            - - ClusterSetup
            - - ClusterVerification
            - - TopoSetup--KVM
            - - Traffic--KVM

            - - DiscoverVnicsOnEdge-1_VNIC-1-3
            - - DisconnectEdge1Vnic2
            - - EWTraffic--KVM
            - - NSTrafficFail--KVM
            - - ReconnectEdge1Vnic2
            - - UndiscoverVnicsOnEdge-1_VNIC-1-3
            - - Traffic--KVM

        ExitSequence:
            - - TopoCleanup--KVM
            - - ClusterCleanup

PLRRemoveAddLRPort:
    <<: *p2_template
    Summary: Verify that traffic resumes after remove/add lrports on PLR
    TestbedSpec: *TestBed_2KVM_ESXEdge
    TestName: PLRRemoveAddLRPort
    WORKLOADS:
        <<: *TopoSR_2Hosts_1Edge_Plr
        <<: *Topo_3MP_3CCP
        Sequence:
            - - ClusterSetup
            - - ClusterVerification
            - - TopoSetup--KVM
            - - Traffic--KVM

            - - DeleteLRP-101
            - - LRP101TrafficFail--KVM
            - - LRP102NSTraffic--KVM
            - - CreateLRP-101_LR-1_IP-192.168.1.1_LSP-101
            - - Traffic--KVM

        ExitSequence:
            - - TopoCleanup--KVM
            - - ClusterCleanup

PLRRemoveAddLRPortAttachment:
    <<: *p2_template
    Summary: Verify that traffic resumes after remove/add lrport attachments on PLR
    TestbedSpec: *TestBed_2KVM_ESXEdge
    TestName: PLRRemoveAddLRPortAttachment
    WORKLOADS:
        <<: *TopoSR_2Hosts_1Edge_Plr
        <<: *Topo_3MP_3CCP
        Sequence:
            - - ClusterSetup
            - - ClusterVerification
            - - TopoSetup--KVM
            - - Traffic--KVM

            # (XXX) To detach the ULR/LR Port from current LSP, create a dummy
            # LSwitch and attach the LRPort to a new LSP on that switch.
            - - CreateLS-999
            - - CreateLSP-999_LS-999

            # Detach/Attach LRPort.
            - - AttachLRP-101_LSP-999
            - - VerifyAttachmentLRP-101_LSP-999
            - - LRP101TrafficFail--KVM
            - - LRP102NSTraffic--KVM
            - - AttachLRP-101_LSP-101
            - - VerifyAttachmentLRP-101_LSP-101
            - - Traffic--KVM

            # Detach/Attach ULRPort.
            - - AttachULRP-1_LSP-999
            - - VerifyAttachmentULRP-1_LSP-999
            - - NSTrafficFail--KVM
            - - EWTraffic--KVM
            - - AttachULRP-1_LSP-201
            - - VerifyAttachmentULRP-1_LSP-201
            - - DeleteLSP-999
            - - DeleteLS-999

            - - Traffic--KVM

        ExitSequence:
            - - TopoCleanup--KVM
            - - ClusterCleanup

PLRDeleteAdd:
    <<: *p2_template
    Summary: Verify that traffic resumes after delete/add PLR
    TestbedSpec: *TestBed_2KVM_ESXEdge
    TestName: PLRDeleteAdd
    WORKLOADS:
        <<: *TopoSR_2Hosts_1Edge_Plr
        <<: *Topo_3MP_3CCP
        Sequence:
            - - ClusterSetup
            - - ClusterVerification
            - - TopoSetup--KVM
            - - Traffic--KVM

            - - L3Cleanup
            - - TrafficFail--KVM
            - - L3Setup
            - - SRSetup--KVM
            - - Traffic--KVM

        ExitSequence:
            - - TopoCleanup--KVM
            - - ClusterCleanup

PLRModifyLRPortIP:
    <<: *p2_template
    Summary: Verify that traffic resumes after modifying lrport IP on PLR
    TestbedSpec: *TestBed_2KVM_ESXEdge
    TestName: PLRModifyLRPortIP
    WORKLOADS:
        <<: *TopoSR_2Hosts_1Edge_Plr
        <<: *Topo_3MP_3CCP
        Sequence:
            - - ClusterSetup
            - - ClusterVerification
            - - TopoSetup--KVM
            - - Traffic--KVM

            - - ReconfigureLRP-101_LR-1_IP-192.168.1.254_Prefix-24
            - - SRSetup--KVM
            - - Traffic--KVM

        ExitSequence:
            - - TopoCleanup--KVM
            - - ClusterCleanup

PLRModifyLSIPs:
    <<: *p2_template
    Summary: Verify that traffic resumes after modifying lswitch IP subnets on PLR
    TestbedSpec: *TestBed_2KVM_ESXEdge
    TestName: PLRModifyLSIPs
    WORKLOADS:
        <<: *TopoSR_2Hosts_1Edge_Plr
        <<: *Topo_3MP_3CCP
        Sequence:
            - - ClusterSetup
            - - ClusterVerification
            - - TopoSetup--KVM
            - - Traffic--KVM

            # Change the addresses of LS101, configure things accordingly
            - - ReconfigureLRP-101_IP-192.168.70.1
            - - ConfigureVM1Vif1IP-192.168.70.10
            - - SRSetup--KVM
            - - Traffic--KVM

        ExitSequence:
            - - TopoCleanup--KVM
            - - ClusterCleanup

PLRPowerDownUpVMs:
    <<: *p2_template
    Summary: Verify traffic resumes after power down/up VMs
    TestbedSpec: *TestBed_2KVM_ESXEdge
    TestName: PLRPowerDownUpVMs
    WORKLOADS:
        <<: *TopoSR_2Hosts_1Edge_Plr
        <<: *Topo_3MP_3CCP
        Sequence:
            - - ClusterSetup
            - - ClusterVerification
            - - TopoSetup--KVM
            - - Traffic--KVM

            - - PowerOffVM-1
            - - PowerOnVM-1
            - - ConfigureVM1Vif1IP-192.168.1.10
            - - ConfigureVM1Vif2IP-192.168.91.10
            - - SRSetup--KVM

            - - Traffic--KVM

        ExitSequence:
            - - TopoCleanup--KVM
            - - ClusterCleanup

PLRRemoveAddHypervisors:
    <<: *p2_template
    Summary: Verify that traffic resumes remove/add hypervisor
    TestbedSpec: *TestBed_2KVM_ESXEdge
    TestName: PLRRemoveAddHypervisors
    WORKLOADS:
        <<: *TopoSR_2Hosts_1Edge_Plr
        <<: *Topo_3MP_3CCP
        Sequence:
            - - ClusterSetup
            - - ClusterVerification
            - - TopoSetup--KVM
            - - Traffic--KVM

            - - DeleteTN-1
            - - CreateTN-1_HOSTNODE-1_TZ-1_VMNIC-1

            - - Traffic--KVM
        ExitSequence:
            - - TopoCleanup--KVM
            - - ClusterCleanup

PLRRebootHypervisor:
    <<: *p2_template
    Summary: Verify that traffic resumes after rebooting hypervisor
    TestbedSpec: *TestBed_2KVM_ESXEdge
    TestName: PLRRebootHypervisor
    WORKLOADS:
        <<: *TopoSR_2Hosts_1Edge_Plr
        <<: *Topo_3MP_3CCP
        Sequence:
            - - ClusterSetup
            - - ClusterVerification
            - - TopoSetup--KVM
            - - Traffic--KVM

            - - RebootKVM-2
            - - PowerOnVM-1
            - - ConfigureVM1Vif1IP-192.168.1.10
            - - ConfigureVM1Vif2IP-192.168.91.10
            - - SRSetup--KVM

            - - Traffic--KVM

        ExitSequence:
            - - TopoCleanup--KVM
            - - ClusterCleanup

PLRRebootController:
    <<: *p2_template
    Summary: Verify that traffic resumes after rebooting controller
    TestbedSpec: *TestBed_2KVM_ESXEdge
    TestName: PLRRebootController
    WORKLOADS:
        <<: *TopoSR_2Hosts_1Edge_Plr
        <<: *Topo_3MP_3CCP
        Sequence:
            - - ClusterSetup
            - - ClusterVerification
            - - TopoSetup--KVM
            - - Traffic--KVM

            - - RebootNSXC-1
            - - Traffic--KVM
            - - RebootNSXC-1
              - RebootNSXC-2
              - RebootNSXC-3
            - - Traffic--KVM

        ExitSequence:
            - - TopoCleanup--KVM
            - - ClusterCleanup

PLRRebootManager:
    <<: *p2_template
    Summary: Verify that traffic resumes after rebooting manager
    TestbedSpec: *TestBed_2KVM_ESXEdge
    TestName: PLRRebootManager
    WORKLOADS:
        <<: *TopoSR_2Hosts_1Edge_Plr
        <<: *Topo_3MP_3CCP
        Sequence:
            - - ClusterSetup
            - - ClusterVerification
            - - TopoSetup--KVM
            - - Traffic--KVM

            - - RebootNSXM-1
            - - Traffic--KVM

        ExitSequence:
            - - TopoCleanup--KVM
            - - ClusterCleanup

PLRDownUpVirtualNics:
    <<: *p2_template
    Summary: Verify that traffic resumes after down/up vifs
    TestbedSpec: *TestBed_2KVM_ESXEdge
    TestName: PLRDownUpVirtualNics
    WORKLOADS:
        <<: *TopoSR_2Hosts_1Edge_Plr
        <<: *Topo_3MP_3CCP
        Sequence:
            - - ClusterSetup
            - - ClusterVerification
            - - TopoSetup--KVM
            - - Traffic--KVM

            #- - DisconnectVM1Vif1
            #  - DisconnectVM2Vif1
            #  - DisconnectVM100Vif1
            #- - ReconnectVM1Vif1
            #  - ReconnectVM2Vif1
            #  - ReconnectVM100Vif1
            - - Traffic--KVM

        ExitSequence:
            - - TopoCleanup--KVM
            - - ClusterCleanup
